{% load mfa_tags %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EverSpace - Chat Rooms</title>
    <!-- Bootstrap 5.3 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Modern Ocean & Sunset Theme */
            --primary-gradient: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 50%, #45B7D1 100%);
            --secondary-gradient: linear-gradient(135deg, #96CEB4 0%, #FECA57 100%);
            --success-gradient: linear-gradient(135deg, #00C9FF 0%, #92FE9D 100%);
            --danger-gradient: linear-gradient(135deg, #FC466B 0%, #3F5EFB 100%);
            --warning-gradient: linear-gradient(135deg, #FDBB2D 0%, #22C1C3 100%);
            --glass-bg: rgba(20, 25, 40, 0.3);
            --glass-border: rgba(255, 255, 255, 0.15);
            --dark-bg: #0F1419;
            --dark-card: #1A202C;
            --darker-card: #2D3748;
            --text-primary: #F7FAFC;
            --text-secondary: #A0AEC0;
            --text-muted: #718096;
            --accent-coral: #FF6B6B;
            --accent-teal: #4ECDC4;
            --accent-blue: #45B7D1;
            --accent-mint: #96CEB4;
            --accent-yellow: #FECA57;
            --border-radius-lg: 24px;
            --border-radius-md: 16px;
            --border-radius-sm: 12px;
            --shadow-glass: 0 8px 32px rgba(15, 20, 25, 0.4);
            --shadow-elevated: 0 20px 40px rgba(15, 20, 25, 0.6);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0F1419 0%, #1A202C 30%, #2D3748 70%, #4A5568 100%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* Animated Background */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg, var(--accent-coral), var(--accent-teal));
            border-radius: 50%;
            animation: float 8s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-30px) rotate(180deg); opacity: 0.3; }
        }

        /* Modern Navigation */
        .navbar-modern {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 700;
            font-size: 1.75rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 107, 107, 0.3);
        }

        /* Main Container */
        .main-container {
            padding-top: 100px;
            min-height: 100vh;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 3rem;
        }

        .hero-title {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            text-shadow: 0 0 50px rgba(255, 107, 107, 0.3);
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            font-weight: 400;
        }

        /* Room Cards */
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .room-card {
            background: var(--dark-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-glass);
            text-decoration: none;
            color: white;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .room-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .room-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-elevated);
            background: var(--darker-card);
            color: var(--text-primary);
            text-decoration: none;
            border-color: var(--accent-teal);
        }

        .room-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .room-name {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .room-description {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .room-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .room-number {
            color: var(--accent-teal) !important;
            font-weight: 600 !important;
            font-family: 'Courier New', monospace !important;
            background: rgba(78, 205, 196, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .room-privacy-badge {
            display: inline-block;
            background: rgba(252, 70, 107, 0.2);
            color: var(--accent-coral);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid rgba(252, 70, 107, 0.3);
            margin-left: 0.5rem;
        }

        /* Create Room Section */
        .create-room-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 2.5rem;
            text-align: center;
            margin-bottom: 3rem;
            position: relative;
        }

        /* Room Notifications */
        .room-notification {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            animation: slideInFromTop 0.5s ease-out;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .room-notification.success {
            background: linear-gradient(135deg, rgba(150, 206, 180, 0.2), rgba(78, 205, 196, 0.2));
            color: var(--accent-mint);
            border-color: var(--accent-teal);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.2);
        }

        .room-notification.error {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.2), rgba(252, 70, 107, 0.2));
            color: var(--accent-coral);
            border-color: var(--accent-coral);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.2);
        }

        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .create-room-title {
            font-size: 1.75rem;
            font-weight: 600;
            background: var(--secondary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .room-input {
            background: var(--dark-card);
            border: 2px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: 1rem;
            color: var(--text-primary);
            width: 100%;
            max-width: 400px;
            margin: 0 auto 1.5rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .room-input:focus {
            background: var(--darker-card);
            border-color: var(--accent-teal);
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(78, 205, 196, 0.25);
            transform: translateY(-2px);
        }

        .room-input::placeholder {
            color: var(--text-muted);
        }

        /* Modern Buttons */
        .btn-modern {
            padding: 0.875rem 2rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            font-size: 1rem;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-primary-modern {
            background: var(--primary-gradient);
            color: var(--text-primary);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }

        .btn-primary-modern:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
            filter: brightness(1.1);
        }

        .btn-outline-modern {
            background: var(--dark-card);
            border: 2px solid var(--accent-teal);
            color: var(--accent-teal);
            backdrop-filter: blur(10px);
        }

        .btn-outline-modern:hover {
            background: var(--accent-teal);
            border-color: var(--accent-teal);
            color: var(--dark-bg);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.3);
        }

        /* User Panel */
        .user-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            color: white;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: 600;
            overflow: hidden;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-fallback {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .welcome-text {
            font-size: 1.1rem;
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Dropdown */
        .dropdown-menu {
            background: var(--darker-card);
            border: 1px solid var(--accent-teal);
            border-radius: var(--border-radius-md);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow-elevated);
        }

        .dropdown-item {
            color: var(--text-primary);
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 2px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            color: var(--dark-bg);
            transform: translateX(5px);
        }

        .dropdown-item.text-primary {
            color: var(--accent-teal) !important;
        }

        .dropdown-item.text-danger {
            color: var(--accent-coral) !important;
        }

        .dropdown-item.text-danger:hover {
            background: var(--danger-gradient);
            color: var(--text-primary) !important;
        }

        .dropdown-divider {
            border-color: var(--glass-border);
            margin: 8px 0;
        }

        /* Room Creation Enhancements */
        .input-group-room {
            position: relative;
            margin-bottom: 1rem;
        }

        .room-input {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(78, 205, 196, 0.3);
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 0.1em;
            transition: all 0.3s ease;
            padding: 1rem;
            border-radius: var(--border-radius-md);
            width: 100%;
        }

        .room-input:focus {
            outline: none;
            border-color: var(--accent-teal);
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.4);
            transform: translateY(-2px);
        }

        .room-input.invalid {
            border-color: var(--accent-coral);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .room-input.valid {
            border-color: var(--accent-teal);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);
            background: rgba(78, 205, 196, 0.05);
        }

        .input-helper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-helper i {
            color: var(--accent-teal);
        }

        /* Digit Progress Bar */
        .digit-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-coral), var(--accent-teal));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Friends Section */
        .friends-section {
            margin-bottom: 3rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .friends-subsection {
            margin-bottom: 2rem;
        }

        .subsection-title {
            color: var(--accent-coral);
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255, 107, 107, 0.2);
        }

        .friend-requests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .friend-request-card,
        .friend-card {
            background: var(--dark-card);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            box-shadow: var(--shadow-glass);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .friend-request-card:hover,
        .friend-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-elevated);
            border-color: var(--accent-teal);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            flex-shrink: 0;
            overflow: hidden;
            border: 2px solid var(--accent-teal);
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-info h6 {
            color: var(--text-primary);
            margin: 0 0 0.25rem 0;
            font-weight: 600;
        }

        .friend-status {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .btn-friend-accept,
        .btn-friend-decline,
        .btn-friend-chat,
        .btn-friend-remove {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .btn-friend-accept {
            background: linear-gradient(135deg, var(--accent-mint), #A8E6CF);
            color: white;
        }

        .btn-friend-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(150, 206, 180, 0.4);
        }

        .btn-friend-decline,
        .btn-friend-remove {
            background: linear-gradient(135deg, var(--accent-coral), #FF8E8E);
            color: white;
        }

        .btn-friend-decline:hover,
        .btn-friend-remove:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-friend-chat {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-teal));
            color: white;
        }

        .btn-friend-chat:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(69, 183, 209, 0.4);
            color: white;
            text-decoration: none;
        }

        .empty-friends {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--accent-coral);
            opacity: 0.5;
        }

        .empty-friends h5 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        /* Room Setup Modal */
        .room-setup-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 20, 25, 0.9);
            backdrop-filter: blur(15px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content-large {
            background: var(--dark-card);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-elevated);
            border: 1px solid var(--accent-teal);
            max-width: 600px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideUp 0.3s ease;
        }

        .room-created-success {
            text-align: center;
            padding: 1rem 0 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 1.5rem;
        }

        .success-icon {
            width: 60px;
            height: 60px;
            background: var(--success-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
            color: white;
            animation: successPulse 2s ease-in-out infinite;
        }

        .room-created-success h4 {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .room-created-success p {
            color: var(--text-secondary);
            margin: 0;
        }

        @keyframes successPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 201, 255, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(0, 201, 255, 0); }
        }

        /* Setup Form */
        .setup-form {
            padding: 0 1rem;
        }

        .form-section {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .description-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            padding: 1rem;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .description-textarea:focus {
            outline: none;
            border-color: var(--accent-teal);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        /* Visibility Options */
        .visibility-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .visibility-option {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .visibility-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .visibility-option.active {
            border-color: var(--accent-teal);
            background: rgba(78, 205, 196, 0.1);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
        }

        .option-icon {
            width: 50px;
            height: 50px;
            background: var(--primary-gradient);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .visibility-option.active .option-icon {
            background: var(--success-gradient);
            animation: iconGlow 2s ease-in-out infinite alternate;
        }

        .option-content h5 {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .option-content p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        /* Password Section */
        .password-section {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 1.5rem;
        }

        .password-inputs {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .password-group {
            position: relative;
        }

        .password-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            padding: 1rem 3rem 1rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent-teal);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .password-toggle:hover {
            color: var(--accent-teal);
        }

        .password-match-indicator {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .password-match-indicator.match {
            background: rgba(0, 201, 255, 0.1);
            color: var(--accent-teal);
            border: 1px solid rgba(0, 201, 255, 0.3);
        }

        .password-match-indicator.no-match {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent-coral);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(69, 183, 209, 0.1));
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            background: rgba(255, 107, 107, 0.2);
            color: var(--accent-coral);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-body p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .description-textarea {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            padding: 1rem;
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            transition: all 0.3s ease;
        }

        .description-textarea:focus {
            outline: none;
            border-color: var(--accent-teal);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }

        .btn-secondary-modern {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: var(--border-radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
        }

        .btn-secondary-modern:hover {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideUp {
            from { 
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }
            
            .rooms-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .room-card,
            .create-room-section,
            .user-panel {
                margin: 1rem;
                padding: 1.5rem;
            }
        }
        .create-room {
            background-color: #2f3136;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #40444b;
        }
        .create-room input {
            background-color: #40444b;
            border: 1px solid #72767d;
            color: #ffffff;
            padding: 10px;
            border-radius: 4px;
            width: 200px;
            margin-right: 10px;
        }
        .create-room button {
            background-color: #7289da;
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
        .create-room button:hover {
            background-color: #677bc4;
        }
        .user-menu {
            color: #ffffff;
        }
        .btn {
            text-decoration: none;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        .btn-outline-primary {
            border: 2px solid var(--accent-blue);
            color: var(--accent-blue);
            background: var(--dark-card);
            transition: all 0.3s ease;
        }
        .btn-outline-primary:hover {
            background: var(--accent-blue);
            color: var(--dark-bg);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(69, 183, 209, 0.3);
        }
        .btn-danger {
            background: var(--danger-gradient);
            color: var(--text-primary);
            border: none;
            transition: all 0.3s ease;
        }
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 70, 107, 0.4);
            filter: brightness(1.1);
        }

        /* Notification Bell */
        .notification-bell {
            position: relative;
            display: inline-block;
            margin-right: 1.5rem;
        }

        .notification-icon {
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notification-icon:hover {
            color: var(--accent-teal);
            transform: scale(1.1);
        }

        .notification-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-coral);
            color: white;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 700;
            animation: pulse-badge 2s ease-in-out infinite;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .notification-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            width: 350px;
            max-height: 400px;
            background: var(--dark-card);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-elevated);
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            cursor: pointer;
            transition: background 0.2s ease;
            text-decoration: none;
            display: block;
            color: var(--text-primary);
        }

        .notification-item:hover {
            background: var(--darker-card);
        }

        .notification-item.unread {
            background: rgba(78, 205, 196, 0.05);
            border-left: 3px solid var(--accent-teal);
        }

        .notification-content {
            display: flex;
            align-items: start;
            gap: 0.75rem;
        }

        .notification-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
        }

        .notification-message {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .notification-empty {
            padding: 2rem;
            text-align: center;
            color: var(--text-muted);
        }

        .mark-all-read {
            color: var(--accent-teal);
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
        }

        .mark-all-read:hover {
            color: var(--accent-coral);
        }
    </style>
</head>
<body>
    <!-- Animated Background Particles -->
    <div class="particles" id="particles"></div>

    <!-- Modern Navigation -->
    <nav class="navbar navbar-expand-lg navbar-modern fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-rocket me-2"></i>EverSpace
            </a>
            <div class="d-flex align-items-center">
                <div class="user-info me-3">
                    <a href="{% url 'chat:my_profile' %}" class="user-avatar" title="View My Profile">
                        {% if user.profile.pixel_avatar %}
                            <img src="/static/chat/images/pixel_avatars/{{ user.profile.pixel_avatar }}.png" alt="{{ user.username }}">
                        {% elif user.profile.profile_picture %}
                            <img src="{{ user.profile.profile_picture.url }}" alt="{{ user.username }}">
                        {% else %}
                            <div class="user-avatar-fallback">
                                {{ user.first_name.0|default:user.username.0|upper }}
                            </div>
                        {% endif %}
                    </a>
                    <span class="welcome-text">{{ user.first_name|default:user.username }}</span>
                </div>
                <div class="user-actions">
                    <!-- Notification Bell -->
                    <div class="notification-bell">
                        <i class="fas fa-bell notification-icon" id="notificationBell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        
                        <!-- Notification Dropdown -->
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <span>Notifications</span>
                                <a href="#" class="mark-all-read" id="markAllRead">Mark all read</a>
                            </div>
                            <div id="notificationList">
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                                    <p>No new notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <a href="{% url 'chat:my_profile' %}" class="btn btn-outline-modern btn-sm me-2" title="View My Profile">
                        <i class="fas fa-user me-1"></i>My Profile
                    </a>
                    <a href="{% url 'chat:edit_profile' %}" class="btn btn-outline-modern btn-sm me-2" title="Edit Profile">
                        <i class="fas fa-user-edit me-1"></i>Edit
                    </a>
                    <div class="dropdown me-2">
                        <button class="btn btn-outline-modern btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" id="securityDropdown">
                            <i class="fas fa-shield-alt me-1"></i>Security
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="securityDropdown">
                            {% if not user|has_mfa_enabled %}
                                <li><a class="dropdown-item text-primary" href="{% url 'auth_mfa_setup' %}">
                                    <i class="fas fa-shield-alt me-2"></i>Set Up MFA
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><span class="dropdown-item-text text-muted small">
                                    <i class="fas fa-info-circle me-1"></i>Enable MFA for enhanced security
                                </span></li>
                            {% else %}
                                <li><div class="dropdown-item-text text-success small">
                                    <i class="fas fa-check-circle me-1"></i>MFA Enabled
                                </div></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'auth_view_codes' %}">
                                    <i class="fas fa-key me-2"></i>View Backup Codes
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'auth_regenerate_codes' %}">
                                    <i class="fas fa-redo me-2"></i>Generate New Codes
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="{% url 'auth_mfa_disable' %}">
                                    <i class="fas fa-times me-2"></i>Disable MFA
                                </a></li>
                            {% endif %}
                        </ul>
                    </div>
                    <form method="post" action="{% url 'auth_logout' %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-outline-modern btn-sm">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="container">
            <!-- Hero Section -->
            <div class="hero-section">
                <h1 class="hero-title">
                    <i class="fas fa-comments me-3"></i>Chat Rooms
                </h1>
                <p class="hero-subtitle">Connect with others in secure, real-time conversations</p>
            </div>
            
            <!-- Create Room Section -->
            <div class="create-room-section">
                <div class="create-room-title">
                    <i class="fas fa-plus-circle me-2"></i>Create or Join a Room
                </div>
                <form onsubmit="joinRoom(event)" id="room-creation-form">
                    {% csrf_token %}
                    <div class="input-group-room">
                        <input type="text" id="room-name-input" class="room-input" placeholder="Enter exactly 7 digits (e.g., 1234567)" maxlength="7" pattern="[0-9]{7}" required>
                        <div class="input-helper">
                            <i class="fas fa-info-circle"></i>
                            <span id="digit-counter">0/7 digits entered</span>
                        </div>
                        <div class="digit-progress">
                            <div class="progress-bar" id="digit-progress-bar"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary-modern btn-modern">
                        <i class="fas fa-rocket me-2"></i>Create Room
                    </button>
                </form>
            </div>

            <!-- Room Setup Modal -->
            <div class="room-setup-modal" id="room-setup-modal" style="display: none;">
                <div class="modal-content-large">
                    <div class="modal-header">
                        <h3><i class="fas fa-cog me-2"></i>Setup Your Room</h3>
                        <button type="button" class="close-modal" onclick="closeSetupModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="room-created-success">
                            <div class="success-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <h4>Room <span id="created-room-name"></span> Created!</h4>
                            <p>Now let's set up your room with some details.</p>
                        </div>

                        <div class="setup-form">
                            <!-- Description Section -->
                            <div class="form-section">
                                <label class="form-label">
                                    <i class="fas fa-edit me-2"></i>Room Description
                                </label>
                                <textarea id="room-description-input" class="description-textarea" placeholder="Describe what this room is about... (optional)" rows="3"></textarea>
                            </div>

                            <!-- Visibility Section -->
                            <div class="form-section">
                                <label class="form-label">
                                    <i class="fas fa-eye me-2"></i>Room Visibility
                                </label>
                                <div class="visibility-options">
                                    <div class="visibility-option active" data-value="public">
                                        <div class="option-icon">
                                            <i class="fas fa-globe"></i>
                                        </div>
                                        <div class="option-content">
                                            <h5>Public Room</h5>
                                            <p>Anyone can join this room</p>
                                        </div>
                                    </div>
                                    <div class="visibility-option" data-value="private">
                                        <div class="option-icon">
                                            <i class="fas fa-lock"></i>
                                        </div>
                                        <div class="option-content">
                                            <h5>Private Room</h5>
                                            <p>Password required to join</p>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="room-visibility" value="public">
                            </div>

                            <!-- Password Section (Hidden by default) -->
                            <div class="form-section password-section" id="password-section" style="display: none;">
                                <label class="form-label">
                                    <i class="fas fa-key me-2"></i>Room Password
                                </label>
                                <div class="password-inputs">
                                    <div class="password-group">
                                        <input type="password" id="room-password" class="password-input" placeholder="Enter room password">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('room-password')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="password-group">
                                        <input type="password" id="room-password-confirm" class="password-input" placeholder="Confirm room password">
                                        <button type="button" class="password-toggle" onclick="togglePasswordVisibility('room-password-confirm')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="password-match-indicator" id="password-match-indicator">
                                    <i class="fas fa-info-circle me-2"></i>Passwords must match
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary-modern" onclick="cancelRoomCreation()">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary-modern" onclick="finalizeRoomCreation()" id="finalize-btn">
                            <i class="fas fa-rocket me-2"></i>Create & Enter Room
                        </button>
                    </div>
                </div>
            </div>

            <!-- Friends Section -->
            {% if user.is_authenticated %}
            <div class="friends-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-users me-3"></i>Friends
                    </h2>
                    <p class="section-subtitle">Connect and chat with your friends</p>
                </div>

                <!-- Friend Requests -->
                {% if incoming_requests %}
                <div class="friends-subsection">
                    <h4 class="subsection-title">
                        <i class="fas fa-user-clock me-2"></i>
                        Friend Requests ({{ incoming_requests|length }})
                    </h4>
                    <div class="friend-requests-grid">
                        {% for request in incoming_requests %}
                        <div class="friend-request-card">
                            <div class="friend-avatar">
                                {% if request.sender.profile.pixel_avatar %}
                                    <img src="/static/chat/images/pixel_avatars/{{ request.sender.profile.pixel_avatar }}.png" alt="{{ request.sender.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% elif request.sender.profile.profile_picture %}
                                    <img src="{{ request.sender.profile.profile_picture.url }}" alt="{{ request.sender.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                    {{ request.sender.username|slice:":1"|upper }}
                                {% endif %}
                            </div>
                            <div class="friend-info">
                                <h6>{{ request.sender.username }}</h6>
                                <p class="friend-status">{{ request.created_at|timesince }} ago</p>
                            </div>
                            <div class="friend-actions">
                                <a href="{% url 'chat:view_profile' request.sender.username %}" class="btn-friend-accept" title="View Profile">
                                    <i class="fas fa-user"></i>
                                </a>
                                <button class="btn-friend-accept" onclick="respondToRequest({{ request.id }}, 'accepted')" title="Accept">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn-friend-decline" onclick="respondToRequest({{ request.id }}, 'declined')" title="Decline">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Friends List -->
                <div class="friends-subsection">
                    <h4 class="subsection-title">
                        <i class="fas fa-user-friends me-2"></i>
                        My Friends ({{ friends|length }})
                    </h4>
                    
                    {% if friends %}
                        <div class="friends-grid">
                            {% for friend in friends %}
                            <div class="friend-card">
                                <div class="friend-avatar">
                                    {% if friend.profile.pixel_avatar %}
                                        <img src="/static/chat/images/pixel_avatars/{{ friend.profile.pixel_avatar }}.png" alt="{{ friend.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% elif friend.profile.profile_picture %}
                                        <img src="{{ friend.profile.profile_picture.url }}" alt="{{ friend.username }}" style="width: 100%; height: 100%; object-fit: cover;">
                                    {% else %}
                                        {{ friend.username|slice:":1"|upper }}
                                    {% endif %}
                                </div>
                                <div class="friend-info">
                                    <h6>{{ friend.username }}</h6>
                                    <p class="friend-status">
                                        <i class="fas fa-circle text-success me-1"></i>Online
                                    </p>
                                </div>
                                <div class="friend-actions">
                                    <a href="{% url 'chat:view_profile' friend.username %}" class="btn-friend-chat" title="View Profile">
                                        <i class="fas fa-user"></i>
                                    </a>
                                    <a href="{% url 'chat:private_chat' friend.username %}" class="btn-friend-chat" title="Send Message">
                                        <i class="fas fa-comment"></i>
                                    </a>
                                    <button class="btn-friend-remove" onclick="removeFriend('{{ friend.username }}')" title="Remove Friend">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-friends">
                            <div class="empty-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <h5>No Friends Yet</h5>
                            <p>Start making friends by joining chat rooms!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

                <!-- Available Rooms -->
                <div class="rooms-grid">
                    {% for room in rooms %}
                        <a href="{% url 'chat:chat_room' room.name %}" class="room-card">
                            <div class="room-icon">
                                {% if room.is_private %}
                                    <i class="fas fa-lock"></i>
                                {% else %}
                                    <i class="fas fa-hashtag"></i>
                                {% endif %}
                            </div>
                            <div class="room-name">
                                {{ room.name }}
                                {% if room.is_private %}
                                    <span class="room-privacy-badge">
                                        <i class="fas fa-lock"></i> Private
                                    </span>
                                {% endif %}
                            </div>
                            <div class="room-description">
                                {% if room.description %}
                                    {{ room.description }}
                                {% elif room.name == 'general' %}
                                    General discussion and community chat
                                {% elif room.name == 'gaming' %}
                                    Gaming discussions and team coordination
                                {% elif room.name == 'tech' %}
                                    Technology news and development chat
                                {% elif room.name == 'random' %}
                                    Random conversations and off-topic discussions
                                {% else %}
                                    {% if room.description %}
                                        {{ room.description }}
                                    {% else %}
                                        Join the conversation in room {{ room.name }}
                                    {% endif %}
                                {% endif %}
                            </div>
                            <div class="room-stats">
                                <span><i class="fas fa-comments me-1"></i>{{ room.messages.count }} messages</span>
                                {% if room.creator %}
                                    <span><i class="fas fa-user me-1"></i>by {{ room.creator.first_name|default:room.creator.username }}</span>
                                {% endif %}
                                <span class="room-number">#{{ room.name }}</span>
                                <span><i class="fas fa-arrow-right"></i></span>
                            </div>
                        </a>
                    {% empty %}
                        <div class="col-12 text-center">
                            <div class="create-room-section">
                                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h4 style="color: rgba(255,255,255,0.8);">No rooms available yet</h4>
                                <p style="color: rgba(255,255,255,0.6);">Be the first to create a room and start chatting!</p>
                            </div>
                        </div>
                    {% endfor %}
                </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Particles Animation -->
    <script>
        function createParticles() {
            const particles = document.getElementById('particles');
            const particleCount = 40;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 8 + 's';
                particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                particles.appendChild(particle);
            }
        }
        
        document.addEventListener('DOMContentLoaded', createParticles);

        // Store current room for description modal
        let currentCreatedRoom = null;

        // Real-time input validation for exactly 7 digits
        document.addEventListener('DOMContentLoaded', function() {
            const roomInput = document.getElementById('room-name-input');
            const digitCounter = document.getElementById('digit-counter');
            const progressBar = document.getElementById('digit-progress-bar');
            
            roomInput.addEventListener('input', function(e) {
                // Remove any non-digit characters
                this.value = this.value.replace(/[^0-9]/g, '');
                
                // Limit to 7 digits
                if (this.value.length > 7) {
                    this.value = this.value.slice(0, 7);
                }
                
                const currentLength = this.value.length;
                const progress = (currentLength / 7) * 100;
                
                // Update counter and progress bar
                digitCounter.textContent = `${currentLength}/7 digits entered`;
                progressBar.style.width = progress + '%';
                
                // Update placeholder and styling based on input
                if (currentLength === 0) {
                    this.placeholder = 'Enter exactly 7 digits (e.g., 1234567)';
                    this.classList.remove('valid', 'invalid');
                } else if (currentLength < 7) {
                    this.placeholder = `${7 - currentLength} more digits needed`;
                    this.classList.add('invalid');
                    this.classList.remove('valid');
                } else {
                    this.placeholder = 'Perfect! Ready to create room';
                    this.classList.add('valid');
                    this.classList.remove('invalid');
                }
            });

            roomInput.addEventListener('keypress', function(e) {
                // Only allow digits
                if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
                    e.preventDefault();
                }
            });

            // Initialize visibility option handlers
            document.querySelectorAll('.visibility-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.visibility-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('room-visibility').value = this.dataset.value;
                    
                    const passwordSection = document.getElementById('password-section');
                    if (this.dataset.value === 'private') {
                        passwordSection.style.display = 'block';
                    } else {
                        passwordSection.style.display = 'none';
                        document.getElementById('room-password').value = '';
                        document.getElementById('room-password-confirm').value = '';
                    }
                });
            });

            // Password matching validation
            function validatePasswords() {
                const password = document.getElementById('room-password').value;
                const confirmPassword = document.getElementById('room-password-confirm').value;
                const indicator = document.getElementById('password-match-indicator');
                
                if (password && confirmPassword) {
                    if (password === confirmPassword) {
                        indicator.textContent = ' Passwords match';
                        indicator.className = 'password-match-indicator match';
                    } else {
                        indicator.textContent = ' Passwords do not match';
                        indicator.className = 'password-match-indicator no-match';
                    }
                } else {
                    indicator.textContent = 'Passwords must match';
                    indicator.className = 'password-match-indicator';
                }
            }

            document.getElementById('room-password').addEventListener('input', validatePasswords);
            document.getElementById('room-password-confirm').addEventListener('input', validatePasswords);
        });

        function joinRoom(event) {
            event.preventDefault();
            const roomName = document.getElementById('room-name-input').value.trim();
            
            // Strictly validate exactly 7 digits
            if (roomName.length !== 7 || !/^\d{7}$/.test(roomName)) {
                showNotification('You must enter exactly 7 digits! Current: ' + roomName.length + ' digits', 'error');
                return;
            }
            
            // Add loading animation to button
            const button = event.target.querySelector('button');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Checking Room...';
            button.disabled = true;
            
            // Check if room already exists first
            fetch('/chat/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `room_name=${encodeURIComponent(roomName)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Store room info for setup modal
                    currentCreatedRoom = {
                        name: roomName,
                        redirect_url: data.redirect_url
                    };
                    
                    // Show success message
                    showNotification(data.message, 'success');
                    
                    // Show setup modal after short delay
                    setTimeout(() => {
                        showSetupModal(roomName);
                    }, 800);
                    
                    // Reset form
                    resetRoomForm();
                } else {
                    // Show error message
                    showNotification(data.message, 'error');
                }
                
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('An error occurred while creating the room. Please try again.', 'error');
                // Reset button
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function resetRoomForm() {
            const roomInput = document.getElementById('room-name-input');
            const digitCounter = document.getElementById('digit-counter');
            const progressBar = document.getElementById('digit-progress-bar');
            
            roomInput.value = '';
            roomInput.placeholder = 'Enter exactly 7 digits (e.g., 1234567)';
            roomInput.classList.remove('valid', 'invalid');
            digitCounter.textContent = '0/7 digits entered';
            progressBar.style.width = '0%';
        }

        function showSetupModal(roomName) {
            document.getElementById('created-room-name').textContent = roomName;
            document.getElementById('room-setup-modal').style.display = 'flex';
            document.getElementById('room-description-input').focus();
        }

        function closeSetupModal() {
            document.getElementById('room-setup-modal').style.display = 'none';
            resetSetupForm();
        }

        function resetSetupForm() {
            document.getElementById('room-description-input').value = '';
            document.getElementById('room-visibility').value = 'public';
            document.getElementById('room-password').value = '';
            document.getElementById('room-password-confirm').value = '';
            document.getElementById('password-section').style.display = 'none';
            
            // Reset visibility options
            document.querySelectorAll('.visibility-option').forEach(opt => opt.classList.remove('active'));
            document.querySelector('.visibility-option[data-value="public"]').classList.add('active');
            
            // Reset password indicator
            const indicator = document.getElementById('password-match-indicator');
            indicator.textContent = 'Passwords must match';
            indicator.className = 'password-match-indicator';
        }

        function cancelRoomCreation() {
            if (currentCreatedRoom) {
                // Delete the created room since user cancelled
                fetch('/chat/delete-room/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `room_name=${encodeURIComponent(currentCreatedRoom.name)}`
                })
                .then(() => {
                    showNotification('Room creation cancelled', 'info');
                });
            }
            closeSetupModal();
            currentCreatedRoom = null;
        }

        function finalizeRoomCreation() {
            const description = document.getElementById('room-description-input').value.trim();
            const visibility = document.getElementById('room-visibility').value;
            const password = document.getElementById('room-password').value;
            const confirmPassword = document.getElementById('room-password-confirm').value;
            
            // Validate private room password
            if (visibility === 'private') {
                if (!password) {
                    showNotification('Password is required for private rooms!', 'error');
                    return;
                }
                if (password !== confirmPassword) {
                    showNotification('Passwords do not match!', 'error');
                    return;
                }
                if (password.length < 4) {
                    showNotification('Password must be at least 4 characters!', 'error');
                    return;
                }
            }
            
            if (!currentCreatedRoom) {
                showNotification('Error: Room information not found. Please try creating the room again.', 'error');
                return;
            }
            
            // Disable button during processing
            const finalizeBtn = document.getElementById('finalize-btn');
            const originalText = finalizeBtn.innerHTML;
            finalizeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Setting up room...';
            finalizeBtn.disabled = true;
            
            // Update room with all settings
            fetch('/chat/finalize-room/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `room_name=${encodeURIComponent(currentCreatedRoom.name)}&description=${encodeURIComponent(description)}&visibility=${visibility}&password=${encodeURIComponent(password)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Room setup complete! Entering room...', 'success');
                    closeSetupModal();
                    
                    // Navigate to room after short delay
                    setTimeout(() => {
                        window.location.href = currentCreatedRoom.redirect_url;
                    }, 1000);
                } else {
                    showNotification(data.message || 'Failed to setup room', 'error');
                    finalizeBtn.innerHTML = originalText;
                    finalizeBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Error setting up room. Please try again.', 'error');
                finalizeBtn.innerHTML = originalText;
                finalizeBtn.disabled = false;
            });
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('room-description-modal').style.display === 'flex') {
                skipDescription();
            }
        });

        // Function to show notifications
        function showNotification(message, type) {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.room-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `room-notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i>
                ${message}
            `;
            
            // Insert notification above the form
            const createSection = document.querySelector('.create-room-section');
            createSection.insertBefore(notification, createSection.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Friend Request Functions
        function respondToRequest(requestId, status) {
            fetch('{% url "chat:respond_friend_request" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `request_id=${requestId}&status=${status}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('An error occurred while responding to the request.', 'error');
            });
        }

        function removeFriend(username) {
            if (!confirm(`Are you sure you want to remove ${username} from your friends?`)) {
                return;
            }

            fetch('{% url "chat:send_friend_request" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: `username=${username}&action=remove`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(data.message, 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                } else {
                    showNotification(data.message, 'error');
                }
            })
            .catch(error => {
                showNotification('An error occurred while removing the friend.', 'error');
            });
        }

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ===== NOTIFICATION SYSTEM =====
        let notificationSocket = null;
        let unreadCount = 0;

        // Initialize notification system
        document.addEventListener('DOMContentLoaded', function() {
            initializeNotifications();
            setupNotificationListeners();
            fetchUnreadCount();
        });

        function initializeNotifications() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
            
            notificationSocket = new WebSocket(wsUrl);
            
            notificationSocket.onopen = function(e) {
                console.log('Notification WebSocket connected');
            };
            
            notificationSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                console.log('Notification received:', data);
                
                // Handle all notification types
                handleIncomingNotification(data);
            };
            
            notificationSocket.onclose = function(e) {
                console.log('Notification WebSocket closed. Reconnecting in 3 seconds...');
                setTimeout(initializeNotifications, 3000);
            };
            
            notificationSocket.onerror = function(e) {
                console.error('Notification WebSocket error:', e);
            };
        }

        function setupNotificationListeners() {
            const notificationBell = document.getElementById('notificationBell');
            const notificationDropdown = document.getElementById('notificationDropdown');
            const markAllRead = document.getElementById('markAllRead');
            
            // Toggle dropdown on bell click
            notificationBell.addEventListener('click', function(e) {
                e.stopPropagation();
                notificationDropdown.classList.toggle('show');
                if (notificationDropdown.classList.contains('show')) {
                    fetchNotifications();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.notification-bell')) {
                    notificationDropdown.classList.remove('show');
                }
            });
            
            // Mark all as read
            markAllRead.addEventListener('click', function(e) {
                e.preventDefault();
                markAllNotificationsRead();
            });
        }

        function handleIncomingNotification(data) {
            unreadCount++;
            updateNotificationBadge();
            
            // Get notification details based on type
            let title = 'New Notification';
            let body = '';
            
            switch(data.notification_type || data.type) {
                case 'message':
                case 'new_message':
                    title = 'New Message from ' + data.sender;
                    body = data.message.substring(0, 100);
                    break;
                case 'friend_request':
                    title = 'Friend Request';
                    body = data.sender + ' sent you a friend request';
                    break;
                case 'friend_accepted':
                    title = 'Friend Request Accepted';
                    body = data.sender + ' accepted your friend request';
                    break;
                case 'kicked':
                    title = 'Kicked from Room';
                    body = 'You were kicked from ' + data.room + ' by ' + data.sender;
                    break;
                case 'banned':
                    title = 'Banned from Room';
                    body = 'You were banned from ' + data.room + ' by ' + data.sender;
                    break;
                default:
                    title = data.title || 'New Notification';
                    body = data.message || '';
            }
            
            // Show browser notification if permitted
            if (Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/static/chat/img/notification-icon.png'
                });
            }
            
            // Play notification sound
            playNotificationSound();
        }

        function fetchUnreadCount() {
            fetch('/chat/notifications/count/')
                .then(response => response.json())
                .then(data => {
                    unreadCount = data.count;
                    updateNotificationBadge();
                })
                .catch(error => console.error('Error fetching unread count:', error));
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function fetchNotifications() {
            fetch('/chat/notifications/list/')
                .then(response => response.json())
                .then(data => {
                    displayNotifications(data.notifications);
                })
                .catch(error => console.error('Error fetching notifications:', error));
        }

        function displayNotifications(notifications) {
            const notificationList = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                notificationList.innerHTML = `
                    <div class="notification-empty">
                        <i class="fas fa-bell-slash" style="font-size: 2rem; margin-bottom: 0.5rem; opacity: 0.3;"></i>
                        <p>No new notifications</p>
                    </div>
                `;
                return;
            }
            
            console.log('[NOTIFICATIONS] Displaying', notifications.length, 'notifications');
            
            notificationList.innerHTML = notifications.map(notif => {
                const timeAgo = formatTimeAgo(new Date(notif.timestamp));
                const unreadClass = notif.is_read ? '' : 'unread';
                const avatar = notif.sender.charAt(0).toUpperCase();
                
                console.log('[NOTIFICATION]', notif.type, '-', notif.title, '- Link:', notif.link);
                
                // Get icon and color based on notification type
                let icon = 'fa-bell';
                let iconColor = 'var(--accent-teal)';
                
                switch(notif.type) {
                    case 'message':
                        icon = 'fa-envelope';
                        iconColor = 'var(--accent-teal)';
                        break;
                    case 'friend_request':
                        icon = 'fa-user-plus';
                        iconColor = 'var(--accent-coral)';
                        break;
                    case 'friend_accepted':
                        icon = 'fa-user-check';
                        iconColor = '#4CAF50';
                        break;
                    case 'kicked':
                        icon = 'fa-door-open';
                        iconColor = '#FF9800';
                        break;
                    case 'banned':
                        icon = 'fa-ban';
                        iconColor = '#F44336';
                        break;
                    case 'room_deleted':
                        icon = 'fa-trash';
                        iconColor = '#9E9E9E';
                        break;
                    case 'transfer_ownership':
                        icon = 'fa-crown';
                        iconColor = '#FFD700';
                        break;
                }
                
                // Ensure link has proper format
                let link = notif.link || '#';
                if (link && !link.startsWith('http') && !link.startsWith('/')) {
                    link = '/' + link;
                }
                
                return `
                    <a href="${link}" class="notification-item ${unreadClass}" data-id="${notif.id}" data-link="${link}">
                        <div class="notification-content">
                            <div class="notification-avatar" style="background: ${iconColor};">
                                <i class="fas ${icon}" style="color: white;"></i>
                            </div>
                            <div class="notification-text">
                                <div class="notification-message">
                                    <strong>${notif.title}</strong>
                                    <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary);">${notif.message.substring(0, 80)}${notif.message.length > 80 ? '...' : ''}</p>
                                </div>
                                <div class="notification-time">${timeAgo}</div>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
            
            // Add click handlers to mark as read and navigate
            notificationList.querySelectorAll('.notification-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault(); // Always prevent default to control navigation
                    
                    const notifId = this.dataset.id;
                    const link = this.dataset.link;
                    
                    console.log('[NOTIFICATION CLICK] ID:', notifId, 'Link:', link);
                    
                    // Mark as read
                    if (notifId) {
                        markNotificationRead(notifId);
                    }
                    
                    // Navigate if valid link
                    if (link && link !== '#' && link !== 'null' && link !== 'undefined') {
                        console.log('[NOTIFICATION CLICK] Navigating to:', link);
                        setTimeout(() => {
                            window.location.href = link;
                        }, 100);
                    } else {
                        console.warn('[NOTIFICATION CLICK] Invalid link:', link);
                    }
                });
            });
        }

        function markNotificationRead(notificationId) {
            fetch(`/chat/notifications/mark-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(() => {
                if (unreadCount > 0) {
                    unreadCount--;
                    updateNotificationBadge();
                }
            })
            .catch(error => console.error('Error marking notification as read:', error));
        }

        function markAllNotificationsRead() {
            fetch('/chat/notifications/mark-all-read/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(() => {
                unreadCount = 0;
                updateNotificationBadge();
                fetchNotifications();
            })
            .catch(error => console.error('Error marking all as read:', error));
        }

        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' days ago';
            return date.toLocaleDateString();
        }

        function playNotificationSound() {
            // Optional: Add a subtle notification sound
            const audio = new Audio('/static/chat/sounds/notification.mp3');
            audio.volume = 0.3;
            audio.play().catch(() => {}); // Ignore if sound fails
        }

        // Request notification permission on page load
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
</body>
</html>