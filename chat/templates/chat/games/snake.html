<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêç Snake Game - Earn Evercoins</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradientShift 20s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .game-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 30px 80px rgba(0,0,0,0.5);
            max-width: 620px;
            width: 100%;
            text-align: center;
            position: relative;
        }

        .game-title {
            font-size: 42px;
            font-weight: 900;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
            animation: titleBounce 2s ease-in-out infinite;
        }

        @keyframes titleBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .stat-box {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 14px;
            border-radius: 14px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-box:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 22px;
            font-weight: bold;
            margin-top: 5px;
        }

        #gameCanvas {
            border: 4px solid #667eea;
            border-radius: 15px;
            background: #f8f9fa;
            margin: 15px auto;
            display: block;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 100%;
            height: auto;
            transition: transform 0.2s;
        }

        .controls {
            margin: 15px 0;
            padding: 12px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            font-size: 13px;
            color: #555;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 16px 38px;
            border-radius: 14px;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin: 8px 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 140px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            animation: fadeIn 0.3s;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 480px;
            width: 90%;
            text-align: center;
            animation: scaleIn 0.4s;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        @keyframes scaleIn {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-score {
            font-size: 52px;
            font-weight: bold;
            color: #764ba2;
            margin: 20px 0;
            animation: numberPop 0.6s;
        }

        @keyframes numberPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        .reward-display {
            font-size: 30px;
            font-weight: bold;
            color: #10b981;
            margin: 20px 0;
            padding: 18px;
            background: linear-gradient(135deg, #d4fc79, #96e6a1);
            border-radius: 14px;
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0%, 100% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 40px rgba(16, 185, 129, 0.8); }
        }

        .time-warning {
            color: #ef4444;
            font-size: 15px;
            margin: 12px 0;
            padding: 12px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 10px;
            border: 2px solid #ef4444;
            font-weight: 600;
        }

        .time-success {
            color: #10b981;
            font-size: 15px;
            margin: 12px 0;
            padding: 12px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            border: 2px solid #10b981;
            font-weight: 600;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @media (max-width: 640px) {
            .game-title { font-size: 32px; }
            .stats-container { gap: 8px; }
            .stat-box { padding: 10px; }
            .stat-value { font-size: 18px; }
            .btn { padding: 14px 28px; font-size: 15px; min-width: 120px; }
            .modal-content { padding: 30px 20px; }
            .modal-title { font-size: 28px; }
            .modal-score { font-size: 42px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-title">üêç SNAKE GAME</div>
        <p style="color: #666; margin-bottom: 15px;">üçé Eat & Grow | ‚è±Ô∏è Play 5+ mins for full reward!</p>
        
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-label">Score</div>
                <div class="stat-value" id="score">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Time</div>
                <div class="stat-value" id="timer">0:00</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Length</div>
                <div class="stat-value" id="length">3</div>
            </div>
        </div>

        <canvas id="gameCanvas" width="400" height="400"></canvas>

        <div class="controls">
            <p>üéÆ Use Arrow Keys to control the snake</p>
            <p>üí° Play 5+ minutes to earn maximum Evercoins!</p>
        </div>

        <button class="btn" onclick="startGame()" id="startBtn">üéÆ Start Game</button>
        <button class="btn" onclick="pauseGame()" id="pauseBtn" style="display:none;">‚è∏Ô∏è Pause</button>
        <button class="btn" onclick="window.close()" style="background: linear-gradient(135deg, #ef4444, #dc2626);">‚ùå Exit</button>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">üéÆ Game Over!</div>
            <div class="modal-score" id="finalScore">Score: 0</div>
            <div id="timeMessage"></div>
            <div class="reward-display" id="rewardDisplay">ü™ô +0 Evercoins</div>
            <button class="btn" onclick="playAgain()">üîÑ Play Again</button>
            <button class="btn" onclick="window.close()" style="background: linear-gradient(135deg, #ef4444, #dc2626);">‚ùå Close</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 20;
        const tileCount = canvas.width / gridSize;

        let snake = [{x: 10, y: 10}];
        let food = {x: 15, y: 15};
        let dx = 0;
        let dy = 0;
        let score = 0;
        let gameLoop = null;
        let gameSpeed = 100;
        let isPaused = false;
        
        // Time tracking
        let gameStartTime = null;
        let gameEndTime = null;
        let timerInterval = null;
        let elapsedSeconds = 0;

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'eat':
                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(783.99, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'gameover':
                    oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                    oscillator.type = 'sawtooth';
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'start':
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(554.37, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
            }
        }

        function createConfetti() {
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = '10px';
                    confetti.style.height = '10px';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.top = '-10px';
                    confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
                    confetti.style.animation = 'confettiFall 3s linear forwards';
                    confetti.style.zIndex = '9999';
                    document.body.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        function updateTimer() {
            elapsedSeconds++;
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Keyboard controls
        document.addEventListener('keydown', changeDirection);

        function changeDirection(event) {
            switch(event.key) {
                case 'ArrowUp':
                    event.preventDefault();
                    if (dy === 0) { dx = 0; dy = -1; }
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    if (dy === 0) { dx = 0; dy = 1; }
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    if (dx === 0) { dx = -1; dy = 0; }
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    if (dx === 0) { dx = 1; dy = 0; }
                    break;
                case ' ':
                    event.preventDefault();
                    if (gameLoop && !isPaused) pauseGame();
                    break;
            }
        }

        function startGame() {
            snake = [{x: 10, y: 10}, {x: 9, y: 10}, {x: 8, y: 10}];
            dx = 1;
            dy = 0;
            score = 0;
            elapsedSeconds = 0;
            isPaused = false;
            
            document.getElementById('score').textContent = score;
            document.getElementById('length').textContent = snake.length;
            document.getElementById('timer').textContent = '0:00';
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';
            
            gameStartTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);
            
            placeFood();
            playSound('start');
            
            if (gameLoop) clearInterval(gameLoop);
            gameLoop = setInterval(update, gameSpeed);
        }

        function pauseGame() {
            if (isPaused) {
                gameLoop = setInterval(update, gameSpeed);
                timerInterval = setInterval(updateTimer, 1000);
                document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pause';
                isPaused = false;
            } else {
                clearInterval(gameLoop);
                clearInterval(timerInterval);
                document.getElementById('pauseBtn').textContent = '‚ñ∂Ô∏è Resume';
                isPaused = true;
            }
        }

        function playAgain() {
            document.getElementById('gameOverModal').style.display = 'none';
            startGame();
        }

        function update() {
            moveSnake();
            if (checkCollision()) {
                gameOver();
                return;
            }
            if (checkFoodCollision()) {
                score += 10;
                document.getElementById('score').textContent = score;
                snake.push({...snake[snake.length - 1]});
                document.getElementById('length').textContent = snake.length;
                placeFood();
                playSound('eat');
                
                // Visual feedback
                canvas.style.transform = 'scale(1.02)';
                setTimeout(() => canvas.style.transform = 'scale(1)', 100);
            }
            draw();
        }

        function moveSnake() {
            const head = {x: snake[0].x + dx, y: snake[0].y + dy};
            snake.unshift(head);
            snake.pop();
        }

        function checkCollision() {
            const head = snake[0];
            if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
                return true;
            }
            for (let i = 1; i < snake.length; i++) {
                if (head.x === snake[i].x && head.y === snake[i].y) {
                    return true;
                }
            }
            return false;
        }

        function checkFoodCollision() {
            return snake[0].x === food.x && snake[0].y === food.y;
        }

        function draw() {
            // Clear canvas
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw grid
            ctx.strokeStyle = '#e5e7eb';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= tileCount; i++) {
                ctx.beginPath();
                ctx.moveTo(i * gridSize, 0);
                ctx.lineTo(i * gridSize, canvas.height);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(0, i * gridSize);
                ctx.lineTo(canvas.width, i * gridSize);
                ctx.stroke();
            }

            // Draw food with glow effect
            const gradient = ctx.createRadialGradient(
                food.x * gridSize + gridSize/2,
                food.y * gridSize + gridSize/2,
                gridSize/4,
                food.x * gridSize + gridSize/2,
                food.y * gridSize + gridSize/2,
                gridSize
            );
            gradient.addColorStop(0, '#ef4444');
            gradient.addColorStop(1, '#dc2626');
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(
                food.x * gridSize + gridSize/2,
                food.y * gridSize + gridSize/2,
                gridSize/2 - 2,
                0,
                2 * Math.PI
            );
            ctx.fill();

            // Draw snake with gradient
            snake.forEach((segment, index) => {
                const segmentGradient = ctx.createLinearGradient(
                    segment.x * gridSize,
                    segment.y * gridSize,
                    segment.x * gridSize + gridSize,
                    segment.y * gridSize + gridSize
                );
                
                if (index === 0) {
                    segmentGradient.addColorStop(0, '#667eea');
                    segmentGradient.addColorStop(1, '#764ba2');
                } else {
                    segmentGradient.addColorStop(0, '#a78bfa');
                    segmentGradient.addColorStop(1, '#c084fc');
                }
                
                ctx.fillStyle = segmentGradient;
                ctx.fillRect(
                    segment.x * gridSize + 1,
                    segment.y * gridSize + 1,
                    gridSize - 2,
                    gridSize - 2
                );
                
                // Eyes for head
                if (index === 0) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(segment.x * gridSize + 5, segment.y * gridSize + 5, 4, 4);
                    ctx.fillRect(segment.x * gridSize + 11, segment.y * gridSize + 5, 4, 4);
                }
            });
        }

        function placeFood() {
            food.x = Math.floor(Math.random() * tileCount);
            food.y = Math.floor(Math.random() * tileCount);
            
            // Make sure food doesn't spawn on snake
            for (let segment of snake) {
                if (food.x === segment.x && food.y === segment.y) {
                    placeFood();
                    return;
                }
            }
        }

        function gameOver() {
            clearInterval(gameLoop);
            clearInterval(timerInterval);
            gameLoop = null;
            gameEndTime = Date.now();
            
            playSound('gameover');
            
            const playTimeMinutes = elapsedSeconds / 60;
            
            document.getElementById('finalScore').textContent = `Score: ${score}`;
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('startBtn').style.display = 'inline-block';

            let reward = 0;
            let timeMessage = '';
            
            // Reward calculation based on time and score
            if (playTimeMinutes < 2) {
                timeMessage = '<div class="time-warning">‚ö†Ô∏è Played less than 2 minutes - No reward!</div>';
                reward = 0;
            } else if (score < 50) {
                timeMessage = '<div class="time-warning">üìä Low score - Minimum reward only</div>';
                reward = 20;
            } else if (playTimeMinutes >= 5) {
                // Full reward calculation for 5+ minutes
                reward = Math.floor(score / 10) * 5 + Math.floor(snake.length / 5) * 10;
                reward = Math.max(50, Math.min(200, reward));
                timeMessage = '<div class="time-success">‚úÖ Great session! Full reward earned!</div>';
                createConfetti();
            } else {
                // Partial reward for 2-5 minutes
                const timeRatio = playTimeMinutes / 5;
                const baseReward = Math.floor(score / 10) * 3 + Math.floor(snake.length / 5) * 5;
                reward = Math.floor(baseReward * timeRatio);
                reward = Math.max(30, Math.min(150, reward));
                timeMessage = `<div style="color: #f59e0b; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; margin: 12px 0; font-weight: 600;">‚è±Ô∏è Partial reward (${Math.floor(playTimeMinutes)} min). Play 5+ min for full reward!</div>`;
            }

            document.getElementById('timeMessage').innerHTML = timeMessage;
            document.getElementById('rewardDisplay').textContent = `ü™ô +${reward} Evercoins Earned!`;
            document.getElementById('gameOverModal').style.display = 'flex';

            if (reward > 0) {
                submitScore(score, reward, elapsedSeconds);
            }
        }

        function submitScore(score, reward, playTime) {
            fetch('/chat/games/submit-score/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    game_type: 'snake',
                    score: score,
                    reward: reward,
                    play_time: playTime
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Score submitted successfully!');
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Initial draw
        draw();
    </script>
</body>
</html>
